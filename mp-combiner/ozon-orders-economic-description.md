# –ü–æ—è—Å–Ω–µ–Ω–∏–µ –ø–æ–ª–µ–π –≤ –∑–∞–ø—Ä–æ—Å–µ —ç–∫–æ–Ω–æ–º–∏–∫–∏ –∑–∞–∫–∞–∑–æ–≤ –û–∑–æ–Ω

## üìã –û—Å–Ω–æ–≤–Ω—ã–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã –∑–∞–∫–∞–∑–∞

| –ü–æ–ª–µ | –ò—Å—Ç–æ—á–Ω–∏–∫ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –ü—Ä–∏–º–µ—Ä |
|------|----------|------------|--------|
| **posting_number** | `fbs_order.posting_number` | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è –û–∑–æ–Ω | "0100169990-0103-1" |
| **posting_number_short** | –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–µ–∑–∫–∏ | –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–π –æ–¥–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞ | "0100169990-0103" |
| **order_id** | `fbs_order.order_id` | ID –∑–∞–∫–∞–∑–∞ –≤ —Å–∏—Å—Ç–µ–º–µ –û–∑–æ–Ω | "28537586406" |
| **order_number** | `fbs_order.order_number` | –ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ –¥–ª—è –ø–æ–∫—É–ø–∞—Ç–µ–ª—è | –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –Ω–æ–º–µ—Ä |

## üìä –°—Ç–∞—Ç—É—Å –∏ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

| –ü–æ–ª–µ | –ò—Å—Ç–æ—á–Ω–∏–∫ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –í–æ–∑–º–æ–∂–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è |
|------|----------|------------|-------------------|
| **order_status** | `fbs_order.status` | –°—Ç–∞—Ç—É—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è | delivered, cancelled, awaiting_packaging |
| **order_substatus** | `fbs_order.substatus` | –î–µ—Ç–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è | posting_canceled, posting_received |
| **order_date** | `fbs_order.in_process_at` | –î–∞—Ç–∞ –ø—Ä–∏–Ω—è—Ç–∏—è –∑–∞–∫–∞–∑–∞ –≤ –æ–±—Ä–∞–±–æ—Ç–∫—É | 2024-01-11T20:43:21.000Z |
| **shop_name** | `fbs_order.shop_name` | –ù–∞–∑–≤–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞ –ø—Ä–æ–¥–∞–≤—Ü–∞ | "GetPwr" |
| **region** | `posting_analytics_data.region` | –†–µ–≥–∏–æ–Ω –¥–æ—Å—Ç–∞–≤–∫–∏ | "–ú–æ—Å–∫–≤–∞ –∏ –æ–±–ª–∞—Å—Ç—å" |

## üõçÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–≤–∞—Ä–∞—Ö

| –ü–æ–ª–µ | –ò—Å—Ç–æ—á–Ω–∏–∫ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –ü—Ä–∏–º–µ—Ä |
|------|----------|------------|--------|
| **sku** | `posting_product.sku` | SKU —Ç–æ–≤–∞—Ä–∞ –≤ —Å–∏—Å—Ç–µ–º–µ –û–∑–æ–Ω | 1823748558 |
| **offer_id** | `posting_product.offer_id` | –ê—Ä—Ç–∏–∫—É–ª –ø—Ä–æ–¥–∞–≤—Ü–∞ | "1531" |
| **product_name** | `posting_product.name` | –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ | "–ê–∫–∫—É–º—É–ª—è—Ç–æ—Ä Li-ion 18650" |
| **quantity** | `posting_product.quantity` | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–∞ –≤ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ | 1 |
| **product_price** | `posting_product.price` | –¶–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É —Ç–æ–≤–∞—Ä–∞ | 590.00 |
| **unit_selfcost** | `ms_self_cost_data.selfcost` –∏–ª–∏ `posting_product.selfcost` | –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –µ–¥–∏–Ω–∏—Ü—ã —Ç–æ–≤–∞—Ä–∞ | 125.00 |

## üí∞ –†–∞—Å—á–µ—Ç–Ω—ã–µ –ø–æ–ª—è –ø–æ —Ç–æ–≤–∞—Ä–∞–º

| –ü–æ–ª–µ | –§–æ—Ä–º—É–ª–∞ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –õ–æ–≥–∏–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ |
|------|---------|------------|----------------|
| **total_product_revenue** | –ó–∞–≤–∏—Å–∏—Ç –æ—Ç —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞ | –í—ã—Ä—É—á–∫–∞ –æ—Ç —Ç–æ–≤–∞—Ä–∞ —Å —É—á–µ—Ç–æ–º –æ—Ç–º–µ–Ω –∏ –≤–æ–∑–≤—Ä–∞—Ç–æ–≤ | –°–º. —Ä–∞–∑–¥–µ–ª "–õ–æ–≥–∏–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ –≤—ã—Ä—É—á–∫–∏" |
| **total_selfcost** | `quantity * unit_selfcost` (—Ç–æ–ª—å–∫–æ –¥–ª—è –≤–∞–ª–∏–¥–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤) | –û–±—â–∞—è —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å —Ç–æ–≤–∞—Ä–∞ | 0 –¥–ª—è –æ—Ç–º–µ–Ω–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ |

## üè™ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞

| –ü–æ–ª–µ | –ò—Å—Ç–æ—á–Ω–∏–∫ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –ü—Ä–∏–º–µ—Ä |
|------|----------|------------|--------|
| **commission_percent** | `posting_fin_data_product.commission_percent` | –ü—Ä–æ—Ü–µ–Ω—Ç –∫–æ–º–∏—Å—Å–∏–∏ –û–∑–æ–Ω | 22 |
| **commission_amount** | `posting_fin_data_product.commission_amount` | –°—É–º–º–∞ –∫–æ–º–∏—Å—Å–∏–∏ (–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–∞—è) | -147.5 |
| **payout** | `posting_fin_data_product.payout` | –í—ã–ø–ª–∞—Ç–∞ –ø—Ä–æ–¥–∞–≤—Ü—É –æ—Ç –û–∑–æ–Ω | 1131 |
| **total_discount_value** | `posting_fin_data_product.total_discount_value` | –†–∞–∑–º–µ—Ä —Å–∫–∏–¥–∫–∏ –Ω–∞ —Ç–æ–≤–∞—Ä | 1450 |

## üöö –£—Å–ª—É–≥–∏ –ª–æ–≥–∏—Å—Ç–∏–∫–∏ (–¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è)

| –ü–æ–ª–µ | –ò—Å—Ç–æ—á–Ω–∏–∫ JSON | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –¢–∏–ø —Ä–∞—Å—Ö–æ–¥–∞ |
|------|---------------|------------|-------------|
| **service_pickup** | `item_services.marketplace_service_item_pickup` | –ó–∞–±–æ—Ä —Ç–æ–≤–∞—Ä–∞ —Å–æ —Å–∫–ª–∞–¥–∞ | –õ–æ–≥–∏—Å—Ç–∏–∫–∞ |
| **service_delivery** | `item_services.marketplace_service_item_deliv_to_customer` | –î–æ—Å—Ç–∞–≤–∫–∞ –ø–æ–∫—É–ø–∞—Ç–µ–ª—é | –õ–æ–≥–∏—Å—Ç–∏–∫–∞ |
| **service_fulfillment** | `item_services.marketplace_service_item_fulfillment` | –£—Å–ª—É–≥–∏ —Ñ—É–ª—Ñ–∏–ª–º–µ–Ω—Ç–∞ | –õ–æ–≥–∏—Å—Ç–∏–∫–∞ |
| **service_return** | `item_services.marketplace_service_item_return_flow_trans` | –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–æ–≤ | –õ–æ–≥–∏—Å—Ç–∏–∫–∞ |
| **total_services_cost** | –°—É–º–º–∞ –≤—Å–µ—Ö service_* | –û–±—â–∏–µ —Ä–∞—Å—Ö–æ–¥—ã –Ω–∞ —É—Å–ª—É–≥–∏ | –ò—Ç–æ–≥–æ –ª–æ–≥–∏—Å—Ç–∏–∫–∞ |

## üí∏ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—é

| –ü–æ–ª–µ | –ò—Å—Ç–æ—á–Ω–∏–∫ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –ö–∞–∫ —Å—á–∏—Ç–∞–µ—Ç—Å—è |
|------|----------|------------|---------------|
| **transaction_revenue** | `ozon_fin_transaction` | –î–æ—Ö–æ–¥—ã –æ—Ç –≤—Å–µ—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π | SUM(amount > 0) |
| **transaction_net_revenue** | `ozon_fin_transaction` | –ß–∏—Å—Ç–∞—è –≤—ã—Ä—É—á–∫–∞ —Å —É—á–µ—Ç–æ–º –≤–æ–∑–≤—Ä–∞—Ç–æ–≤ | SUM(–¥–æ—Å—Ç–∞–≤–∫–∏ + –≤–æ–∑–≤—Ä–∞—Ç—ã + –æ—Ç–º–µ–Ω—ã) |
| **transaction_commission** | `ozon_fin_transaction` | –ö–æ–º–∏—Å—Å–∏–æ–Ω–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã | SUM(WHERE operation_type_name LIKE '%–∫–æ–º–∏—Å—Å–∏—è%') |
| **transaction_logistics** | `ozon_fin_transaction` | –õ–æ–≥–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ —Ä–∞—Å—Ö–æ–¥—ã | SUM(WHERE operation_type_name LIKE '%–¥–æ—Å—Ç–∞–≤–∫–∞%') |
| **transaction_bonus** | `ozon_fin_transaction` | –†–∞—Å—Ö–æ–¥—ã –Ω–∞ –±–æ–Ω—É—Å—ã | SUM(WHERE operation_type_name LIKE '%–±–æ–Ω—É—Å%') |
| **transaction_promotion** | `ozon_fin_transaction` | –†–∞—Å—Ö–æ–¥—ã –Ω–∞ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ | SUM(WHERE operation_type_name LIKE '%–ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏%') |
| **transaction_total_expenses** | `ozon_fin_transaction` | –í—Å–µ —Ä–∞—Å—Ö–æ–¥—ã –ø–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º | SUM(amount < 0) |

## üìà –≠–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ (–ö–ü–≠)

| –ü–æ–ª–µ | –§–æ—Ä–º—É–ª–∞ | –≠–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–π —Å–º—ã—Å–ª | –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ |
|------|---------|-------------------|------------|
| **gross_profit** | `total_product_revenue - total_selfcost` | –í–∞–ª–æ–≤–∞—è –ø—Ä–∏–±—ã–ª—å | –ë–∞–∑–æ–≤–∞—è —Ä–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å —Ç–æ–≤–∞—Ä–∞ |
| **operating_profit** | `gross_profit - |commission_amount| - |total_services_cost|` | –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è –ø—Ä–∏–±—ã–ª—å | –ü—Ä–∏–±—ã–ª—å –ø–æ—Å–ª–µ —Ä–∞—Å—Ö–æ–¥–æ–≤ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞ |
| **net_profit** | `operating_profit - transaction_bonus - transaction_promotion` | –ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å | –ò—Ç–æ–≥–æ–≤–∞—è –ø—Ä–∏–±—ã–ª—å–Ω–æ—Å—Ç—å –∑–∞–∫–∞–∑–∞ |
| **profit_margin_percent** | `(net_profit / total_product_revenue) * 100` | –†–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å –≤ % | –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Ç–æ–≤–∞—Ä–æ–≤ |

## üîç –ü–æ–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è –∫–∞—á–µ—Å—Ç–≤–∞ –¥–∞–Ω–Ω—ã—Ö

| –ü–æ–ª–µ | –¢–∏–ø | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –í–æ–∑–º–æ–∂–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è |
|------|-----|------------|-------------------|
| **is_valid_order** | `boolean` | –§–ª–∞–≥ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ –∑–∞–∫–∞–∑–∞ | `false` –¥–ª—è cancelled/posting_canceled |
| **has_return_or_cancel** | `boolean` | –ù–∞–ª–∏—á–∏–µ –≤–æ–∑–≤—Ä–∞—Ç–æ–≤/–æ—Ç–º–µ–Ω –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è—Ö | `true` –µ—Å–ª–∏ –µ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤–æ–∑–≤—Ä–∞—Ç–∞/–æ—Ç–º–µ–Ω—ã |
| **return_cancel_amount** | `numeric` | –°—É–º–º–∞ –≤–æ–∑–≤—Ä–∞—Ç–æ–≤/–æ—Ç–º–µ–Ω | –ê–±—Å–æ–ª—é—Ç–Ω–∞—è —Å—É–º–º–∞ –æ–ø–µ—Ä–∞—Ü–∏–π –≤–æ–∑–≤—Ä–∞—Ç–∞ |

## üîç –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

| –ü–æ–ª–µ | –ò—Å—Ç–æ—á–Ω–∏–∫ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –ü—Ä–∏–º–µ—Ä |
|------|----------|------------|--------|
| **operation_types_count** | `COUNT(DISTINCT operation_type)` | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–∏–ø–æ–≤ –æ–ø–µ—Ä–∞—Ü–∏–π –ø–æ –∑–∞–∫–∞–∑—É | 5 |
| **operation_types** | `STRING_AGG(operation_type_name)` | –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –æ–ø–µ—Ä–∞—Ü–∏–π | "–î–æ—Å—Ç–∞–≤–∫–∞; –ö–æ–º–∏—Å—Å–∏—è; –ë–æ–Ω—É—Å—ã" |
| **delivery_date_begin** | `posting_analytics_data.delivery_date_begin` | –ù–∞—á–∞–ª–æ –ø–µ—Ä–∏–æ–¥–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ | 2024-01-12 |
| **delivery_date_end** | `posting_analytics_data.delivery_date_end` | –ö–æ–Ω–µ—Ü –ø–µ—Ä–∏–æ–¥–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ | 2024-01-15 |

## üí° –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã —Ä–∞—Å—á–µ—Ç–æ–≤

### üéØ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –¥–∞–Ω–Ω—ã—Ö:
1. **–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å**: –ú–æ–π–°–∫–ª–∞–¥ (`ms_self_cost_data`) ‚Üí posting_product ‚Üí 0
2. **–§–∏–Ω–∞–Ω—Å—ã**: posting_fin_data_product ‚Üí ozon_fin_transaction
3. **–£—Å–ª—É–≥–∏**: item_services (–¥–µ—Ç–∞–ª—å–Ω–æ) ‚Üí transaction_summary (–∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–æ)

### üìä –õ–æ–≥–∏–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ –≤—ã—Ä—É—á–∫–∏:

```sql
CASE 
    WHEN status = 'cancelled' OR substatus = 'posting_canceled' THEN 0
    WHEN has_return_or_cancel = true THEN GREATEST(transaction_net_revenue, 0)
    ELSE quantity * product_price
END
```

**–û—Ç–º–µ–Ω–µ–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã:**
- `is_valid_order = false`
- `total_product_revenue = 0`
- –í—Å–µ –≤–∏–¥—ã –ø—Ä–∏–±—ã–ª–∏ = 0

**–ó–∞–∫–∞–∑—ã —Å –≤–æ–∑–≤—Ä–∞—Ç–∞–º–∏:**
- `is_valid_order = true`, `has_return_or_cancel = true`
- `total_product_revenue = GREATEST(transaction_net_revenue, 0)`
- –ü—Ä–∏–±—ã–ª—å —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –æ—Ç —á–∏—Å—Ç–æ–π –≤—ã—Ä—É—á–∫–∏

**–û–±—ã—á–Ω—ã–µ –∑–∞–∫–∞–∑—ã:**
- `is_valid_order = true`, `has_return_or_cancel = false`
- `total_product_revenue = quantity * product_price`
- –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ä–∞—Å—á–µ—Ç—ã –ø—Ä–∏–±—ã–ª–∏

### üìà –ü–æ–¥—Ä–æ–±–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ —Ä–∞—Å—á–µ—Ç–∞ –ø—Ä–∏–±—ã–ª–∏:

#### üî¢ –≠—Ç–∞–ø 1: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤—ã—Ä—É—á–∫–∏ (`total_product_revenue`)

```sql
total_product_revenue = CASE 
    WHEN NOT is_valid_order THEN 0  -- –û—Ç–º–µ–Ω–µ–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã
    WHEN has_return_or_cancel THEN GREATEST(transaction_net_revenue, 0)  -- –° –≤–æ–∑–≤—Ä–∞—Ç–∞–º–∏
    ELSE quantity * product_price  -- –û–±—ã—á–Ω—ã–µ –∑–∞–∫–∞–∑—ã
END
```

**–ü—Ä–∏–º–µ—Ä—ã:**
- **–û–±—ã—á–Ω—ã–π –∑–∞–∫–∞–∑:** `2 √ó 590‚ÇΩ = 1,180‚ÇΩ`
- **–û—Ç–º–µ–Ω–µ–Ω–Ω—ã–π –∑–∞–∫–∞–∑:** `0‚ÇΩ` (–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ü–µ–Ω—ã —Ç–æ–≤–∞—Ä–∞)
- **–ó–∞–∫–∞–∑ —Å –≤–æ–∑–≤—Ä–∞—Ç–æ–º:** `GREATEST(-43‚ÇΩ, 0) = 0‚ÇΩ` (–µ—Å–ª–∏ –≤–æ–∑–≤—Ä–∞—Ç –ø—Ä–µ–≤—ã—à–∞–µ—Ç –¥–æ—Ö–æ–¥—ã)

#### üî¢ –≠—Ç–∞–ø 2: –†–∞—Å—á–µ—Ç —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏ (`total_selfcost`)

```sql
total_selfcost = CASE 
    WHEN is_valid_order THEN quantity * unit_selfcost
    ELSE 0 
END
```

**–ü—Ä–∏–º–µ—Ä—ã:**
- **–û–±—ã—á–Ω—ã–π –∑–∞–∫–∞–∑:** `2 √ó 125‚ÇΩ = 250‚ÇΩ`
- **–û—Ç–º–µ–Ω–µ–Ω–Ω—ã–π –∑–∞–∫–∞–∑:** `0‚ÇΩ` (—Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è)

#### üî¢ –≠—Ç–∞–ø 3: –í–∞–ª–æ–≤–∞—è –ø—Ä–∏–±—ã–ª—å (`gross_profit`)

```sql
gross_profit = total_product_revenue - total_selfcost
```

**–ü—Ä–∏–º–µ—Ä—ã:**
- **–û–±—ã—á–Ω—ã–π –∑–∞–∫–∞–∑:** `1,180‚ÇΩ - 250‚ÇΩ = 930‚ÇΩ`
- **–û—Ç–º–µ–Ω–µ–Ω–Ω—ã–π –∑–∞–∫–∞–∑:** `0‚ÇΩ - 0‚ÇΩ = 0‚ÇΩ`
- **–ó–∞–∫–∞–∑ —Å –≤–æ–∑–≤—Ä–∞—Ç–æ–º:** `0‚ÇΩ - 250‚ÇΩ = -250‚ÇΩ` (—É–±—ã—Ç–æ–∫)

#### üî¢ –≠—Ç–∞–ø 4: –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è –ø—Ä–∏–±—ã–ª—å (`operating_profit`)

```sql
operating_profit = gross_profit - ABS(commission_amount) - ABS(total_services_cost)
```

**–†–∞–∑–±–∏–≤–∫–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤:**
- `commission_amount` = `-147.5‚ÇΩ` ‚Üí `ABS(-147.5) = 147.5‚ÇΩ`
- `total_services_cost` = `service_pickup + service_delivery + service_fulfillment + service_return`
- –ü—Ä–∏–º–µ—Ä: `0‚ÇΩ + 0‚ÇΩ + 15‚ÇΩ + 0‚ÇΩ = 15‚ÇΩ`

**–ü—Ä–∏–º–µ—Ä—ã:**
- **–û–±—ã—á–Ω—ã–π –∑–∞–∫–∞–∑:** `930‚ÇΩ - 147.5‚ÇΩ - 15‚ÇΩ = 767.5‚ÇΩ`
- **–û—Ç–º–µ–Ω–µ–Ω–Ω—ã–π –∑–∞–∫–∞–∑:** `0‚ÇΩ - 0‚ÇΩ - 0‚ÇΩ = 0‚ÇΩ`
- **–ó–∞–∫–∞–∑ —Å –≤–æ–∑–≤—Ä–∞—Ç–æ–º:** `-250‚ÇΩ - 147.5‚ÇΩ - 15‚ÇΩ = -412.5‚ÇΩ`

#### üî¢ –≠—Ç–∞–ø 5: –ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å (`net_profit`)

```sql
net_profit = operating_profit - transaction_bonus - transaction_promotion
```

**–†–∞–∑–±–∏–≤–∫–∞ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤:**
- `transaction_bonus` = —Å—É–º–º–∞ –±–æ–Ω—É—Å–æ–≤ –ø–æ–∫—É–ø–∞—Ç–µ–ª—è–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, `7.29‚ÇΩ`)
- `transaction_promotion` = —Ä–∞—Å—Ö–æ–¥—ã –Ω–∞ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `0‚ÇΩ`)

**–ü—Ä–∏–º–µ—Ä—ã:**
- **–û–±—ã—á–Ω—ã–π –∑–∞–∫–∞–∑:** `767.5‚ÇΩ - 7.29‚ÇΩ - 0‚ÇΩ = 760.21‚ÇΩ`
- **–û—Ç–º–µ–Ω–µ–Ω–Ω—ã–π –∑–∞–∫–∞–∑:** `0‚ÇΩ - 0‚ÇΩ - 0‚ÇΩ = 0‚ÇΩ`
- **–ó–∞–∫–∞–∑ —Å –≤–æ–∑–≤—Ä–∞—Ç–æ–º:** `-412.5‚ÇΩ - 7.29‚ÇΩ - 0‚ÇΩ = -419.79‚ÇΩ`

#### üî¢ –≠—Ç–∞–ø 6: –†–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å (`profit_margin_percent`)

```sql
profit_margin_percent = CASE
    WHEN total_product_revenue > 0 THEN 
        ROUND((net_profit / total_product_revenue * 100)::numeric, 2)
    ELSE 0
END
```

**–ü—Ä–∏–º–µ—Ä—ã:**
- **–û–±—ã—á–Ω—ã–π –∑–∞–∫–∞–∑:** `(760.21‚ÇΩ / 1,180‚ÇΩ) √ó 100 = 64.42%`
- **–û—Ç–º–µ–Ω–µ–Ω–Ω—ã–π –∑–∞–∫–∞–∑:** `0%` (–Ω–µ—Ç –≤—ã—Ä—É—á–∫–∏)
- **–ó–∞–∫–∞–∑ —Å –≤–æ–∑–≤—Ä–∞—Ç–æ–º:** `0%` (–≤—ã—Ä—É—á–∫–∞ = 0)

#### üìä –ü–æ–ª–Ω—ã–π –ø—Ä–∏–º–µ—Ä —Ä–∞—Å—á–µ—Ç–∞:

**–û–±—ã—á–Ω—ã–π –∑–∞–∫–∞–∑ (2 —Ç–æ–≤–∞—Ä–∞ –ø–æ 590‚ÇΩ):**
```
1. total_product_revenue = 2 √ó 590‚ÇΩ = 1,180‚ÇΩ
2. total_selfcost = 2 √ó 125‚ÇΩ = 250‚ÇΩ
3. gross_profit = 1,180‚ÇΩ - 250‚ÇΩ = 930‚ÇΩ
4. operating_profit = 930‚ÇΩ - 147.5‚ÇΩ - 15‚ÇΩ = 767.5‚ÇΩ
5. net_profit = 767.5‚ÇΩ - 7.29‚ÇΩ - 0‚ÇΩ = 760.21‚ÇΩ
6. profit_margin_percent = 760.21‚ÇΩ / 1,180‚ÇΩ √ó 100 = 64.42%
```

**–û—Ç–º–µ–Ω–µ–Ω–Ω—ã–π –∑–∞–∫–∞–∑:**
```
1. total_product_revenue = 0‚ÇΩ (is_valid_order = false)
2. total_selfcost = 0‚ÇΩ
3. gross_profit = 0‚ÇΩ
4. operating_profit = 0‚ÇΩ
5. net_profit = 0‚ÇΩ
6. profit_margin_percent = 0%
```

**–ó–∞–∫–∞–∑ —Å –≤–æ–∑–≤—Ä–∞—Ç–æ–º (transaction_net_revenue = -43‚ÇΩ):**
```
1. total_product_revenue = GREATEST(-43‚ÇΩ, 0) = 0‚ÇΩ
2. total_selfcost = 1 √ó 125‚ÇΩ = 125‚ÇΩ (–≤—Å–µ —Ä–∞–≤–Ω–æ —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è)
3. gross_profit = 0‚ÇΩ - 125‚ÇΩ = -125‚ÇΩ
4. operating_profit = -125‚ÇΩ - 147.5‚ÇΩ - 15‚ÇΩ = -287.5‚ÇΩ
5. net_profit = -287.5‚ÇΩ - 7.29‚ÇΩ - 0‚ÇΩ = -294.79‚ÇΩ
6. profit_margin_percent = 0% (—Ç–∞–∫ –∫–∞–∫ –≤—ã—Ä—É—á–∫–∞ = 0)
```

### üîÑ –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–π:
- **posting_number**: `"0100169990-0103-1"` - –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
- **posting_number_short**: `"0100169990-0103"` - –≥—Ä—É–ø–ø–∞ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–π
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø–æ –ª–æ–≥–∏—á–µ—Å–∫–æ–º—É –∑–∞–∫–∞–∑—É

### ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:
1. **–û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è** –≤ –∫–æ–º–∏—Å—Å–∏—è—Ö –∏ —É—Å–ª—É–≥–∞—Ö –±–µ—Ä—É—Ç—Å—è –ø–æ –º–æ–¥—É–ª—é (`ABS()`)
2. **–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏** –∞–≥—Ä–µ–≥–∏—Ä—É—é—Ç—Å—è –ø–æ posting_number
3. **COALESCE** –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ NULL –≤ —Ä–∞—Å—á–µ—Ç–∞—Ö
4. **–ü—Ä–∏–≤–µ–¥–µ–Ω–∏–µ —Ç–∏–ø–æ–≤** –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã `ROUND()`

## üìù –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ê–Ω–∞–ª–∏–∑ –ø—Ä–∏–±—ã–ª—å–Ω–æ—Å—Ç–∏ —Ç–æ–≤–∞—Ä–æ–≤:
```sql
SELECT offer_id, product_name,
       AVG(profit_margin_percent) as avg_margin,
       SUM(net_profit) as total_profit
FROM ozon_orders_economics_view 
WHERE is_valid_order = true
GROUP BY offer_id, product_name
ORDER BY total_profit DESC;
```

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤–æ–∑–≤—Ä–∞—Ç–æ–≤:
```sql
SELECT DATE_TRUNC('month', order_date) as month,
       COUNT(*) FILTER (WHERE has_return_or_cancel) as returns_count,
       SUM(return_cancel_amount) as total_return_amount
FROM ozon_orders_economics_view 
GROUP BY month
ORDER BY month;
```

### –ê–Ω–∞–ª–∏–∑ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:
```sql
SELECT shop_name, region,
       AVG(operating_profit) as avg_operating_profit,
       AVG(total_services_cost) as avg_logistics_cost
FROM ozon_orders_economics_view 
WHERE is_valid_order = true
GROUP BY shop_name, region;
```

### –ö–æ–Ω—Ç—Ä–æ–ª—å –∫–∞—á–µ—Å—Ç–≤–∞ –¥–∞–Ω–Ω—ã—Ö:
```sql
-- –ó–∞–∫–∞–∑—ã –±–µ–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
SELECT COUNT(*) as orders_without_transactions
FROM ozon_orders_economics_view 
WHERE is_valid_order = true 
  AND operation_types_count IS NULL;

-- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –≤—ã—Ä—É—á–∫–∏
SELECT posting_number, 
       total_product_revenue,
       transaction_net_revenue,
       ABS(total_product_revenue - transaction_net_revenue) as difference
FROM ozon_orders_economics_view 
WHERE has_return_or_cancel = true
  AND ABS(total_product_revenue - transaction_net_revenue) > 1;
```